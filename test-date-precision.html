<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Test Dynamic Date Precision</title>
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; }
        .test-section { margin: 20px 0; padding: 15px; border: 1px solid #ddd; border-radius: 5px; }
        .test-input { margin: 10px 0; }
        .result { margin: 5px 0; padding: 5px; background: #f5f5f5; border-radius: 3px; }
        .success { background: #d4edda; color: #155724; }
        .error { background: #f8d7da; color: #721c24; }
    </style>
</head>
<body>
    <h1>Dynamic Date Precision Test</h1>
    
    <div class="test-section">
        <h2>Test Date Precision Detection</h2>
        <div id="precision-tests"></div>
    </div>
    
    <div class="test-section">
        <h2>Test Date Standardization</h2>
        <div id="standardization-tests"></div>
    </div>
    
    <div class="test-section">
        <h2>Interactive Test</h2>
        <input type="text" id="test-input" placeholder="Enter a date to test..." style="width: 300px; padding: 8px;">
        <div id="interactive-result"></div>
    </div>

    <script type="module">
        // Mock the property-types functions for testing
        function detectDatePrecision(dateInput) {
            if (!dateInput || dateInput.trim() === '') {
                return 'day';
            }
            
            const input = dateInput.trim();
            
            // Check for year only (4 digits) - MUST come before decade check
            if (/^\d{4}$/.test(input)) {
                return 'year';
            }
            
            // Check for decade format (e.g., "1990s", "199x", "199X", "199-")
            // More specific patterns to avoid matching regular years
            if (/^\d{3}[0-9][sS]$/.test(input) ||       // 1990s, 1990S
                /^\d{3}[xX]$/.test(input) ||            // 199x, 199X  
                /^\d{3}[-_]$/.test(input)) {            // 199-, 199_
                return 'decade';
            }
            
            // Check for year-month format (YYYY-MM)
            if (/^\d{4}-\d{1,2}$/.test(input)) {
                return 'month';
            }
            
            // Check for full date format (YYYY-MM-DD, DD/MM/YYYY, MM/DD/YYYY, etc.)
            if (/^\d{4}-\d{1,2}-\d{1,2}$/.test(input) || 
                /^\d{1,2}\/\d{1,2}\/\d{4}$/.test(input) ||
                /^\d{1,2}-\d{1,2}-\d{4}$/.test(input) ||
                /^\d{1,2}\.\d{1,2}\.\d{4}$/.test(input)) {
                return 'day';
            }
            
            // Check for partial year formats (e.g., "early 1990", "late 19th century")
            if (/\b\d{4}\b/.test(input)) {
                return 'year';
            }
            
            // Default to day precision for any other format
            return 'day';
        }

        function standardizeDateInput(dateInput) {
            if (!dateInput || dateInput.trim() === '') {
                return { date: '', precision: 'day' };
            }
            
            const input = dateInput.trim();
            const precision = detectDatePrecision(input);
            
            // Handle decade format
            if (precision === 'decade') {
                const decade = input.match(/\d{3}/)[0];
                return { 
                    date: `${decade}0-01-01`, 
                    precision: 'decade',
                    displayValue: `${decade}0s`
                };
            }
            
            // Handle year only
            if (precision === 'year' && /^\d{4}$/.test(input)) {
                return { 
                    date: `${input}-01-01`, 
                    precision: 'year',
                    displayValue: input
                };
            }
            
            // Handle year-month format
            if (precision === 'month') {
                const parts = input.split('-');
                const year = parts[0];
                const month = parts[1].padStart(2, '0');
                return { 
                    date: `${year}-${month}-01`, 
                    precision: 'month',
                    displayValue: `${year}-${month}`
                };
            }
            
            // Handle various full date formats
            if (precision === 'day') {
                let standardDate = input;
                
                // Convert DD/MM/YYYY to YYYY-MM-DD
                if (/^\d{1,2}\/\d{1,2}\/\d{4}$/.test(input)) {
                    const [day, month, year] = input.split('/');
                    standardDate = `${year}-${month.padStart(2, '0')}-${day.padStart(2, '0')}`;
                }
                // Convert DD-MM-YYYY to YYYY-MM-DD
                else if (/^\d{1,2}-\d{1,2}-\d{4}$/.test(input)) {
                    const [day, month, year] = input.split('-');
                    standardDate = `${year}-${month.padStart(2, '0')}-${day.padStart(2, '0')}`;
                }
                // Convert DD.MM.YYYY to YYYY-MM-DD
                else if (/^\d{1,2}\.\d{1,2}\.\d{4}$/.test(input)) {
                    const [day, month, year] = input.split('.');
                    standardDate = `${year}-${month.padStart(2, '0')}-${day.padStart(2, '0')}`;
                }
                
                return { 
                    date: standardDate, 
                    precision: 'day',
                    displayValue: standardDate
                };
            }
            
            // Fallback
            return { date: input, precision: 'day', displayValue: input };
        }

        // Test cases
        const testCases = [
            // Year tests
            { input: '2023', expected: 'year' },
            { input: '1990', expected: 'year' },
            { input: '1945', expected: 'year' },  // This was failing before
            { input: '0001', expected: 'year' },
            { input: '2000', expected: 'year' },
            
            // Month tests
            { input: '2023-06', expected: 'month' },
            { input: '1990-12', expected: 'month' },
            { input: '2000-1', expected: 'month' },
            
            // Day tests
            { input: '2023-06-15', expected: 'day' },
            { input: '15/06/2023', expected: 'day' },
            { input: '06/15/2023', expected: 'day' },
            { input: '15-06-2023', expected: 'day' },
            { input: '15.06.2023', expected: 'day' },
            
            // Decade tests
            { input: '1990s', expected: 'decade' },
            { input: '1990S', expected: 'decade' },
            { input: '199x', expected: 'decade' },
            { input: '199X', expected: 'decade' },
            { input: '199-', expected: 'decade' },
            { input: '199_', expected: 'decade' },
            { input: '200s', expected: 'decade' },  // Edge case: single digit decade
            // Make sure these are NOT detected as decades
            { input: '1945', expected: 'year' },    // 4-digit year should be year, not decade
            
            // Edge cases
            { input: '', expected: 'day' },
            { input: '   ', expected: 'day' },
            { input: 'early 1990', expected: 'year' },
            { input: 'unknown', expected: 'day' }
        ];

        const standardizationTests = [
            { input: '2023', expected: { date: '2023-01-01', precision: 'year', displayValue: '2023' } },
            { input: '2023-06', expected: { date: '2023-06-01', precision: 'month', displayValue: '2023-06' } },
            { input: '2023-06-15', expected: { date: '2023-06-15', precision: 'day', displayValue: '2023-06-15' } },
            { input: '15/06/2023', expected: { date: '2023-06-15', precision: 'day', displayValue: '2023-06-15' } },
            { input: '1990s', expected: { date: '1990-01-01', precision: 'decade', displayValue: '1990s' } }
        ];

        function runTests() {
            // Test precision detection
            const precisionDiv = document.getElementById('precision-tests');
            let precisionResults = '<h3>Precision Detection Results:</h3>';
            
            testCases.forEach(test => {
                const result = detectDatePrecision(test.input);
                const success = result === test.expected;
                precisionResults += `
                    <div class="result ${success ? 'success' : 'error'}">
                        Input: "${test.input}" → Expected: ${test.expected}, Got: ${result} ${success ? '✓' : '✗'}
                    </div>
                `;
            });
            
            precisionDiv.innerHTML = precisionResults;

            // Test standardization
            const standardDiv = document.getElementById('standardization-tests');
            let standardResults = '<h3>Date Standardization Results:</h3>';
            
            standardizationTests.forEach(test => {
                const result = standardizeDateInput(test.input);
                const success = JSON.stringify(result) === JSON.stringify(test.expected);
                standardResults += `
                    <div class="result ${success ? 'success' : 'error'}">
                        Input: "${test.input}"<br>
                        Expected: ${JSON.stringify(test.expected)}<br>
                        Got: ${JSON.stringify(result)} ${success ? '✓' : '✗'}
                    </div>
                `;
            });
            
            standardDiv.innerHTML = standardResults;
        }

        // Interactive test
        const testInput = document.getElementById('test-input');
        const interactiveResult = document.getElementById('interactive-result');
        
        testInput.addEventListener('input', function() {
            const value = this.value;
            const precision = detectDatePrecision(value);
            const standardized = standardizeDateInput(value);
            
            interactiveResult.innerHTML = `
                <div class="result">
                    <strong>Input:</strong> "${value}"<br>
                    <strong>Detected Precision:</strong> ${precision}<br>
                    <strong>Standardized:</strong> ${JSON.stringify(standardized, null, 2)}
                </div>
            `;
        });

        // Run tests on page load
        runTests();
    </script>
</body>
</html>