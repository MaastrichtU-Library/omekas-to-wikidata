<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Integration Test - Reconciliation Modal</title>
    <link rel="stylesheet" href="src/css/style.css">
    <style>
        body {
            font-family: system-ui, -apple-system, sans-serif;
            padding: 20px;
            background: #f5f5f5;
        }
        
        .test-container {
            max-width: 600px;
            margin: 0 auto;
            background: white;
            padding: 30px;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        
        .test-button {
            background: #007bff;
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 6px;
            cursor: pointer;
            margin: 10px;
            font-size: 16px;
        }
        
        .test-button:hover {
            background: #0056b3;
        }
        
        .result {
            margin-top: 20px;
            padding: 15px;
            border-radius: 6px;
            border: 1px solid #e0e0e0;
        }
        
        .success {
            background: #d4edda;
            color: #155724;
            border-color: #c3e6cb;
        }
        
        .error {
            background: #f8d7da;
            color: #721c24;
            border-color: #f5c6cb;
        }
    </style>
</head>
<body>
    <div class="test-container">
        <h1>üß™ Integration Test</h1>
        <p>Testing the redesigned reconciliation modal integration with the main application.</p>
        
        <div style="text-align: center; margin: 30px 0;">
            <button class="test-button" onclick="testWikidataItem()">Test Wikidata Item Modal</button>
            <br>
            <button class="test-button" onclick="testStringValidation()">Test String Validation Modal</button>
            <br>
            <button class="test-button" onclick="testCompatibilityFunctions()">Test Compatibility Functions</button>
        </div>
        
        <div id="result"></div>
    </div>

    <!-- Modal System (same as main app) -->
    <div id="modal-container" class="modal-container hidden">
        <div class="modal">
            <div class="modal-header">
                <h3 id="modal-title">Modal Title</h3>
                <button class="close-button" onclick="closeModal()">√ó</button>
            </div>
            <div class="modal-content" id="modal-content">
                <!-- Content will be inserted here -->
            </div>
            <div class="modal-footer" id="modal-footer">
                <!-- Footer will be inserted here -->
            </div>
        </div>
    </div>

    <script type="module">
        // Import the reconciliation modal functions
        import { 
            createReconciliationModal,
            createReconciliationModalContentFactory,
            createOpenReconciliationModalFactory,
            createModalInteractionHandlers 
        } from './src/js/reconciliation/ui/reconciliation-modal.js';
        
        import { 
            extractRegexConstraints, 
            validateStringValue 
        } from './src/js/reconciliation/ui/validation-engine.js';

        // Mock modal UI system for testing
        const mockModalUI = {
            openModal(title, content, buttons, onClose) {
                document.getElementById('modal-title').textContent = title;
                document.getElementById('modal-content').innerHTML = content;
                document.getElementById('modal-container').classList.remove('hidden');
                this.onCloseCallback = onClose;
            },
            closeModal() {
                document.getElementById('modal-container').classList.add('hidden');
                if (this.onCloseCallback) {
                    this.onCloseCallback();
                }
            }
        };

        // Global functions for modal
        window.closeModal = () => mockModalUI.closeModal();
        window.closeReconciliationModal = () => mockModalUI.closeModal();
        window.confirmReconciliation = () => {
            showResult('Reconciliation confirmed! (Demo)', 'success');
            mockModalUI.closeModal();
        };

        function showResult(message, type) {
            const resultDiv = document.getElementById('result');
            resultDiv.className = `result ${type}`;
            resultDiv.innerHTML = `<strong>${type === 'success' ? '‚úÖ' : '‚ùå'}</strong> ${message}`;
        }

        window.testWikidataItem = function() {
            try {
                const modal = createReconciliationModal(
                    'test-item-1',
                    'dcterms:creator',
                    0,
                    'Virginia Woolf',
                    { datatype: 'wikibase-item' }
                );
                
                mockModalUI.openModal(
                    'Reconcile Creator',
                    modal.innerHTML,
                    [],
                    () => console.log('Modal closed')
                );
                
                showResult('‚ú® Wikidata item modal opened successfully! The modal shows data type, transformation result, and search interface.', 'success');
                
            } catch (error) {
                showResult(`Failed to create Wikidata item modal: ${error.message}`, 'error');
                console.error(error);
            }
        };

        window.testStringValidation = function() {
            try {
                const modal = createReconciliationModal(
                    'test-item-2', 
                    'isbn',
                    0,
                    '978-0-14-028329-X',  // Valid ISBN-13
                    { datatype: 'string' }
                );
                
                mockModalUI.openModal(
                    'Validate ISBN',
                    modal.innerHTML,
                    [],
                    () => console.log('Modal closed')
                );
                
                showResult('‚ú® String validation modal opened successfully! The modal shows validation status, constraints, and editing interface.', 'success');
                
            } catch (error) {
                showResult(`Failed to create string validation modal: ${error.message}`, 'error');
                console.error(error);
            }
        };

        window.testCompatibilityFunctions = function() {
            try {
                // Test the factory functions for backward compatibility
                const mockDependencies = {
                    reconciliationData: {},
                    getPropertyDisplayInfo: () => ({}),
                    getOriginalKeyInfo: () => ({}),
                    getReconciliationRequirementReason: () => 'Test reason',
                    getConstraintSummary: () => 'Test constraints',
                    modalUI: mockModalUI,
                    performAutomaticReconciliation: async () => {},
                    setupDynamicDatePrecision: () => {},
                    setupAutoAdvanceToggle: () => {},
                    createReconciliationModalContent: () => '<div>Test content</div>'
                };

                // Test factory function creation
                const modalContentFactory = createReconciliationModalContentFactory(mockDependencies);
                const openModalFactory = createOpenReconciliationModalFactory(mockDependencies);
                const interactionHandlers = createModalInteractionHandlers({
                    ...mockDependencies,
                    currentReconciliationCell: { current: null },
                    markCellAsReconciled: () => {},
                    markCellAsSkipped: () => {},
                    markCellAsNoItem: () => {},
                    markCellAsString: () => {},
                    getAutoAdvanceSetting: () => false,
                    reconcileNextUnprocessedCell: () => {},
                    setupExpandedSearch: () => {}
                });

                // Test that functions are callable
                if (typeof modalContentFactory === 'function' && 
                    typeof openModalFactory === 'function' && 
                    typeof interactionHandlers.selectMatchAndAdvance === 'function') {
                    
                    showResult('‚ú® All compatibility functions created successfully! The legacy API is fully supported.', 'success');
                } else {
                    showResult('Some compatibility functions are not working correctly.', 'error');
                }
                
            } catch (error) {
                showResult(`Compatibility test failed: ${error.message}`, 'error');
                console.error(error);
            }
        };

        // Test validation engine separately
        setTimeout(() => {
            try {
                const isbnConstraints = extractRegexConstraints('isbn');
                const validation = validateStringValue('9780140283297', isbnConstraints);
                
                console.log('Validation test:', {
                    constraints: isbnConstraints,
                    validation: validation
                });
            } catch (error) {
                console.error('Validation test error:', error);
            }
        }, 100);
    </script>
</body>
</html>