<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Test Date Precision Fix</title>
    <style>
        body { 
            font-family: Arial, sans-serif; 
            margin: 20px; 
            background: #f5f5f5;
        }
        .test-section { 
            margin: 20px 0; 
            padding: 15px; 
            border: 1px solid #ddd; 
            border-radius: 5px; 
            background: white;
        }
        .result { 
            margin: 5px 0; 
            padding: 8px; 
            background: #f8f9fa; 
            border-radius: 3px; 
            border-left: 4px solid #007bff;
        }
        .success { 
            background: #d4edda; 
            color: #155724; 
            border-left-color: #28a745;
        }
        .error { 
            background: #f8d7da; 
            color: #721c24; 
            border-left-color: #dc3545;
        }
        .code {
            font-family: monospace;
            background: #f8f9fa;
            padding: 2px 4px;
            border-radius: 3px;
        }
    </style>
</head>
<body>
    <h1>Date Precision Fix Test</h1>
    
    <div class="test-section">
        <h2>Precision Mapping Function Test</h2>
        <div id="precision-mapping-results"></div>
    </div>
    
    <div class="test-section">
        <h2>Enhanced FormatDate Function Test</h2>
        <div id="format-date-results"></div>
    </div>
    
    <div class="test-section">
        <h2>QuickStatements Format Validation</h2>
        <div id="quickstatements-results"></div>
    </div>

    <script>
        // Mock the functions from export.js for testing
        function getPrecisionNumber(precisionString) {
            const precisionMapping = {
                'day': 11,
                'month': 10,
                'year': 9,
                'decade': 8,
                'century': 7
            };
            
            return precisionMapping[precisionString] || 11;
        }

        function formatDate(dateString, precision = 11) {
            if (!dateString) return null;
            
            try {
                let dateStr = String(dateString).trim();
                let year, month, day;
                
                // Handle decade inputs (e.g., "1990s", "199x")
                if (precision === 8 && /^\d{3}[0-9xX][sS]?$/.test(dateStr)) {
                    const decadeMatch = dateStr.match(/^(\d{3})[0-9xX]/);
                    if (decadeMatch) {
                        year = `${decadeMatch[1]}0`;
                        month = '01';
                        day = '01';
                    }
                }
                // Handle year-only inputs (e.g., "2023")
                else if (/^\d{4}$/.test(dateStr)) {
                    year = dateStr;
                    month = '01';
                    day = '01';
                }
                // Handle year-month inputs (e.g., "2023-05")
                else if (/^\d{4}-\d{1,2}$/.test(dateStr)) {
                    const [y, m] = dateStr.split('-');
                    year = y;
                    month = m.padStart(2, '0');
                    day = '01';
                }
                // Handle full date inputs (e.g., "2023-05-15")
                else if (/^\d{4}-\d{1,2}-\d{1,2}$/.test(dateStr)) {
                    const [y, m, d] = dateStr.split('-');
                    year = y;
                    month = m.padStart(2, '0');
                    day = d.padStart(2, '0');
                }
                // Try to parse as Date object for other formats
                else {
                    const date = new Date(dateStr);
                    if (isNaN(date.getTime())) {
                        return null;
                    }
                    year = String(date.getFullYear());
                    month = String(date.getMonth() + 1).padStart(2, '0');
                    day = String(date.getDate()).padStart(2, '0');
                }
                
                // Validate year is reasonable
                if (!year || year.length < 4 || isNaN(parseInt(year))) {
                    return null;
                }
                
                // Ensure we have valid month and day
                month = month || '01';
                day = day || '01';
                
                return `+${year}-${month}-${day}T00:00:00Z/${precision}`;
            } catch (error) {
                console.error('Error formatting date:', dateString, error);
                return null;
            }
        }

        function runTests() {
            console.log('🧪 Starting Date Precision Fix Tests');
            
            // Test 1: Precision Mapping
            console.log('📊 Testing precision mapping...');
            const precisionResults = document.getElementById('precision-mapping-results');
            
            const precisionTests = [
                { input: 'day', expected: 11 },
                { input: 'month', expected: 10 },
                { input: 'year', expected: 9 },
                { input: 'decade', expected: 8 },
                { input: 'century', expected: 7 },
                { input: 'invalid', expected: 11 } // Default fallback
            ];
            
            precisionTests.forEach(test => {
                const result = getPrecisionNumber(test.input);
                const success = result === test.expected;
                precisionResults.innerHTML += `<div class="result ${success ? 'success' : 'error'}">
                    getPrecisionNumber('${test.input}') → Expected: ${test.expected}, Got: ${result} ${success ? '✓' : '✗'}
                </div>`;
            });
            
            // Test 2: Enhanced FormatDate Function
            console.log('📅 Testing enhanced formatDate function...');
            const formatResults = document.getElementById('format-date-results');
            
            const formatTests = [
                { input: '2023-05-15', precision: 11, expected: '+2023-05-15T00:00:00Z/11', desc: 'Full date with day precision' },
                { input: '2023-05', precision: 10, expected: '+2023-05-01T00:00:00Z/10', desc: 'Year-month with month precision' },
                { input: '2023', precision: 9, expected: '+2023-01-01T00:00:00Z/9', desc: 'Year only with year precision' },
                { input: '1990s', precision: 8, expected: '+1990-01-01T00:00:00Z/8', desc: 'Decade format with decade precision' },
                { input: '199x', precision: 8, expected: '+1990-01-01T00:00:00Z/8', desc: 'Decade with x format' },
                { input: '2023-05-15', precision: 9, expected: '+2023-05-15T00:00:00Z/9', desc: 'Full date with year precision override' },
                { input: '2023', precision: 11, expected: '+2023-01-01T00:00:00Z/11', desc: 'Year only with day precision override' }
            ];
            
            formatTests.forEach(test => {
                const result = formatDate(test.input, test.precision);
                const success = result === test.expected;
                formatResults.innerHTML += `<div class="result ${success ? 'success' : 'error'}">
                    <strong>${test.desc}</strong><br>
                    Input: "${test.input}" with precision ${test.precision}<br>
                    Expected: <span class="code">${test.expected}</span><br>
                    Got: <span class="code">${result}</span> ${success ? '✓' : '✗'}
                </div>`;
            });
            
            // Test 3: QuickStatements Format Validation
            console.log('📝 Testing QuickStatements format...');
            const quickResults = document.getElementById('quickstatements-results');
            
            const mockReconciliationData = [
                {
                    precision: 'year',
                    value: '1990',
                    expectedQS: '+1990-01-01T00:00:00Z/9'
                },
                {
                    precision: 'month', 
                    value: '2023-06',
                    expectedQS: '+2023-06-01T00:00:00Z/10'
                },
                {
                    precision: 'day',
                    value: '2023-06-15',
                    expectedQS: '+2023-06-15T00:00:00Z/11'
                },
                {
                    precision: 'decade',
                    value: '1990s',
                    expectedQS: '+1990-01-01T00:00:00Z/8'
                }
            ];
            
            mockReconciliationData.forEach((data, index) => {
                // Simulate the export process
                const precision = getPrecisionNumber(data.precision);
                const quickStatementsValue = formatDate(data.value, precision);
                const success = quickStatementsValue === data.expectedQS;
                
                quickResults.innerHTML += `<div class="result ${success ? 'success' : 'error'}">
                    <strong>Test ${index + 1}: ${data.precision} precision</strong><br>
                    Original value: "${data.value}"<br>
                    Precision: ${data.precision} → ${precision}<br>
                    QuickStatements: <span class="code">${quickStatementsValue}</span><br>
                    Expected: <span class="code">${data.expectedQS}</span> ${success ? '✓' : '✗'}
                </div>`;
            });
            
            console.log('✅ All tests completed!');
        }

        // Run tests when page loads
        runTests();
    </script>
</body>
</html>