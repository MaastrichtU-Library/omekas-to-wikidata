<!DOCTYPE html>
<html>
<head>
    <title>Test Field Selection Behavior</title>
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; }
        .test-section { margin: 20px 0; padding: 20px; border: 1px solid #ccc; }
        .result { margin: 10px 0; padding: 10px; background: #f5f5f5; }
        .success { background: #d4edda; color: #155724; }
        .error { background: #f8d7da; color: #721c24; }
        button { margin: 5px; padding: 10px 20px; cursor: pointer; }
        select, option { margin: 5px 0; }
    </style>
</head>
<body>
    <h1>Test Field Selection Behavior</h1>
    
    <div class="test-section">
        <h2>Test 1: createElement with selected property</h2>
        <button onclick="testCreateElementSelected()">Run Test 1</button>
        <div id="test1-result" class="result"></div>
        <div id="test1-demo"></div>
    </div>
    
    <div class="test-section">
        <h2>Test 2: Field Priority Logic</h2>
        <button onclick="testFieldPriority()">Run Test 2</button>
        <div id="test2-result" class="result"></div>
    </div>
    
    <div class="test-section">
        <h2>Test 3: State Persistence</h2>
        <button onclick="testStatePersistence()">Run Test 3</button>
        <div id="test3-result" class="result"></div>
    </div>

    <script type="module">
        import { createElement } from './src/js/ui/components.js';
        import { createState } from './src/js/state.js';
        import { extractAvailableFields } from './src/js/mapping/core/data-analyzer.js';
        
        const state = createState();
        window.testState = state;
        window.createElement = createElement;
        window.extractAvailableFields = extractAvailableFields;
        
        window.testCreateElementSelected = function() {
            const result = document.getElementById('test1-result');
            const demo = document.getElementById('test1-demo');
            
            try {
                // Create a select with options where one should be selected
                const select = createElement('select', { id: 'test-select' });
                
                const options = [
                    { value: 'option1', text: 'Option 1', selected: false },
                    { value: 'option2', text: 'Option 2', selected: true },
                    { value: 'option3', text: 'Option 3', selected: false }
                ];
                
                options.forEach(opt => {
                    const option = createElement('option', {
                        value: opt.value,
                        selected: opt.selected
                    }, opt.text);
                    select.appendChild(option);
                });
                
                demo.appendChild(select);
                
                // Test if option2 is selected
                const selectedValue = select.value;
                const selectedOption = select.querySelector('option[selected]');
                
                if (selectedValue === 'option2' && selectedOption && selectedOption.value === 'option2') {
                    result.innerHTML = '<span class="success">✓ createElement properly handles selected property</span>';
                    result.className = 'result success';
                } else {
                    result.innerHTML = `<span class="error">✗ Selected value: ${selectedValue}, Expected: option2</span>`;
                    result.className = 'result error';
                }
            } catch (error) {
                result.innerHTML = `<span class="error">Error: ${error.message}</span>`;
                result.className = 'result error';
            }
        };
        
        window.testFieldPriority = function() {
            const result = document.getElementById('test2-result');
            
            try {
                // Test different field scenarios
                const scenarios = [
                    {
                        name: '@id present',
                        data: { '@id': 'id1', '@value': 'val1', '@type': 'type1', 'o:label': 'label1' },
                        expected: '@id'
                    },
                    {
                        name: 'No @id, @value present',
                        data: { '@value': 'val1', '@type': 'type1', 'o:label': 'label1' },
                        expected: '@value'
                    },
                    {
                        name: 'No @id/@value, other @ field',
                        data: { '@context': 'ctx1', '@type': 'type1', 'o:label': 'label1' },
                        expected: '@context'
                    },
                    {
                        name: 'No @ fields except @type',
                        data: { '@type': 'type1', 'o:label': 'label1', 'dc:title': 'title1' },
                        expected: 'o:label' // First non-@type field
                    }
                ];
                
                let allPassed = true;
                let resultText = '<strong>Field Priority Tests:</strong><br>';
                
                scenarios.forEach(scenario => {
                    const fields = extractAvailableFields(scenario.data);
                    
                    // Simulate the priority logic
                    let selectedField = fields.find(field => field.key === '@id');
                    if (!selectedField) {
                        selectedField = fields.find(field => field.key === '@value');
                    }
                    if (!selectedField) {
                        selectedField = fields.find(field => 
                            field.key.startsWith('@') && field.key !== '@type'
                        );
                    }
                    if (!selectedField) {
                        selectedField = fields.find(field => field.key !== '@type') || fields[0];
                    }
                    
                    const passed = selectedField?.key === scenario.expected;
                    allPassed = allPassed && passed;
                    
                    resultText += `${passed ? '✓' : '✗'} ${scenario.name}: Got ${selectedField?.key}, Expected ${scenario.expected}<br>`;
                });
                
                result.innerHTML = resultText;
                result.className = allPassed ? 'result success' : 'result error';
                
            } catch (error) {
                result.innerHTML = `<span class="error">Error: ${error.message}</span>`;
                result.className = 'result error';
            }
        };
        
        window.testStatePersistence = function() {
            const result = document.getElementById('test3-result');
            
            try {
                const mappingId = 'test-key::P123';
                
                // Test setting and getting field selection
                state.setSelectedTransformationField(mappingId, '@value');
                const retrieved = state.getSelectedTransformationField(mappingId);
                
                if (retrieved === '@value') {
                    result.innerHTML = '<span class="success">✓ Field selection persists in state</span>';
                    result.className = 'result success';
                } else {
                    result.innerHTML = `<span class="error">✗ Got ${retrieved}, Expected @value</span>`;
                    result.className = 'result error';
                }
                
            } catch (error) {
                result.innerHTML = `<span class="error">Error: ${error.message}</span>`;
                result.className = 'result error';
            }
        };
    </script>
</body>
</html>